# API Gateway

## Purpose

The API Gateway is the primary entry point for external clients (like the frontend UI) to interact with the Aethercast system. It provides a unified interface for discovering content, generating podcasts, and retrieving podcast information and audio.

Key Responsibilities:

1.  **Request Routing & Validation:** Receives HTTP requests from clients, validates them, and routes them to the appropriate internal services or handles them directly.
2.  **Service Orchestration (Lightweight):** For some operations, it may directly call other backend services. For complex tasks like full podcast generation, it primarily calls the Central Podcast Orchestrator Agent (CPOA).
3.  **Frontend Serving:** Serves the static files (HTML, CSS, JavaScript) for the Aethercast web frontend.
4.  **Database Interaction:** Manages a shared database (typically SQLite).
    *   It creates and updates records in the `podcasts` table for tracking podcast generation tasks, including status, filepaths, and metadata like `tts_settings_used`.
    *   It reads from the `topics_snippets` table, which acts as a cache for topic and snippet data generated by TDA and CPOA respectively.
5.  **Response Formatting:** Consolidates responses from backend services (or its own data) and formats them into user-friendly JSON responses for the client.

## Configuration

The API Gateway is configured via environment variables, typically managed in a `.env` file within the `aethercast/api_gateway/` directory. Create one by copying the example:

```bash
cp .env.example .env
```

Then, edit the `.env` file. The following variables are used:

-   `TDA_SERVICE_URL`: The URL of the Topic Discovery Agent (TDA) service, used by the `/api/v1/snippets` endpoint.
    -   *Default:* `http://localhost:5000/discover_topics`
-   `DATABASE_FILE`: Path to the SQLite database file. This **must** be the same path used by CPOA and TDA for shared data access.
    -   *Default:* `aethercast_podcasts.db`
-   `API_GW_SNIPPET_CACHE_SIZE`: Maximum number of snippets to fetch from the database cache for the `/api/v1/snippets` endpoint.
    -   *Default:* `10`
-   `API_GW_SNIPPET_CACHE_MAX_AGE_HOURS`: Maximum age (in hours) for a snippet in the database to be considered fresh enough for the cache.
    -   *Default:* `24`
-   `# FEND_DIR`: (Commented out by default) Path to the frontend static files directory.
    -   *Note:* This is typically derived in `main.py` relative to its own location (e.g., `../fend`). Setting this environment variable can override the derivation if needed for specific deployment scenarios.

**Flask Application Parameters:**
The following are standard Flask environment variables used by `main.py` when running the service directly:
-   `FLASK_APP=aethercast/api_gateway/main.py` (standard way to specify app for flask command)
-   `FLASK_RUN_HOST`: Host for the Flask development server.
    -   *Default in `main.py` if run directly:* `0.0.0.0`
-   `FLASK_RUN_PORT`: Port for the Flask development server.
    -   *Default in `main.py` if run directly:* `5001`
-   `FLASK_DEBUG`: To run Flask in debug mode (enables reloader and debugger).
    -   *Default in `main.py` if run directly:* `True`

*(Note: For a production deployment, a proper WSGI server like Gunicorn or uWSGI should be used instead of the Flask development server.)*

## Dependencies

Project dependencies are listed in `requirements.txt`. Install them using pip:

```bash
pip install -r requirements.txt
```
This includes `Flask`, `requests` (for calling TDA), and `python-dotenv`.

## Running the Service

1.  Ensure all backend services that the API Gateway depends on (CPOA and its dependencies like PSWA, VFA, SCA; TDA) are running and configured correctly.
2.  Set up the necessary environment variables for the API Gateway (e.g., in a `.env` file or system environment).
3.  Initialize the database (if it doesn't exist or if schema changes require it):
    The `init_db()` function is called when `main.py` is run directly. If the database file specified by `DATABASE_FILE` does not exist, it will be created with the correct schema. If schema changes have occurred, you might need to manually delete the old database file during development (a warning will be logged if an old schema is detected).
4.  Run the Flask development server:
    ```bash
    python aethercast/api_gateway/main.py
    ```
    This will start the service, typically on `http://0.0.0.0:5001`.

Alternatively, using the `flask` command:
```bash
export FLASK_APP=aethercast/api_gateway/main.py
export FLASK_DEBUG=1 # Optional
flask run --host=0.0.0.0 --port=5001
```

## API Endpoints

### Frontend

-   **`GET /`**: Serves the main `index.html` of the frontend application.
-   **`GET /style.css`**: Serves the CSS stylesheet.
-   **`GET /app.js`**: Serves the main JavaScript application file.

### Health Check

-   **`GET /health`**
    -   **Description:** Returns the health status of the API Gateway, including checks for CPOA module import and database connectivity.
    -   **Success Response (200 OK):**
        ```json
        {
            "status": "API Gateway is healthy",
            "cpoa_podcast_function_status": "successfully imported", // or "failed to import (...)"
            "cpoa_snippet_function_status": "successfully imported", // or "failed to import (...)"
            "database_status": "Database connection successful." // or "Database connection error: ..."
        }
        ```

### Snippets

-   **`GET /api/v1/snippets`**
    -   **Description:** Fetches a list of dynamically generated podcast snippets, suitable for a landing page or general display. This endpoint calls the Central Podcast Orchestrator Agent (CPOA) which orchestrates topic discovery (via TDA), snippet text and cover art prompt generation (via SCA), and image URL generation (via IGA) for a configurable number of snippets. The old database cache for snippets at this endpoint has been removed in favor of on-demand generation.
    -   **Query Parameters:**
        -   `limit` (optional, integer): Number of topics to request from TDA if generating new snippets. Defaults to 5.
    -   **Success Response (200 OK):**
        ```json
        {
            "source": "cache", // or "generation"
            "snippets": [
                {
                    "snippet_id": "snippet_abcdef123",
                    "topic_id": "topic_xyz789",
                    "title": "The Future of AI in Snippets",
                    "summary": "A brief look at how AI is changing snippet generation...",
                    "text_content": "A brief look at how AI is changing snippet generation...",
                    "cover_art_prompt": "Abstract concept of AI and creativity",
                    "image_url": "https://example.com/images/snippet_abcdef123.jpg",
                    // ... other fields from SnippetDataObject as returned by CPOA's orchestrate_snippet_generation
                }
            ]
        }
        ```
    -   **Error Responses:**
        -   `503 Service Unavailable`: If CPOA snippet function is not loaded, or if TDA service call fails.
        -   `500 Internal Server Error`: For other unexpected errors.

### Popular Categories

-   **`GET /api/v1/categories`**
    -   **Description:** Fetches a list of predefined podcast categories by calling the Central Podcast Orchestrator Agent (CPOA).
    -   **Request Payload:** None.
    -   **Success Response (200 OK):**
        ```json
        {
            "categories": [
                "Technology",
                "Science",
                "Lifestyle",
                "Business",
                "Health & Wellness",
                "Arts & Culture",
                "Education",
                "News & Current Events"
            ]
        }
        ```
    -   **Error Responses:**
        -   `500 Internal Server Error`: If CPOA encounters an issue providing the categories.
        -   `503 Service Unavailable`: If the CPOA categories function is not available.

### Podcast Task Management

-   **`POST /api/v1/podcasts`**
    -   **Description:** Initiates a new podcast generation task. The API Gateway creates a preliminary record in the database and then calls CPOA to orchestrate the generation.
    -   **Request Payload (JSON):**
        ```json
        {
            "topic": "The History of Podcasting",
            "voice_params": { // Optional
                "voice_name": "en-GB-News-K",
                "language_code": "en-GB",
                "speaking_rate": 0.9,
                "pitch": -1.5
            },
            "client_id": "your_unique_client_session_id_here" // Optional: For real-time UI updates
        }
        ```
        -   `topic` (string, required): The main topic for the podcast.
        -   `voice_params` (object, optional): Parameters to customize the voice synthesis (see VFA documentation for details).
        -   `client_id` (string, optional): A unique identifier for the client session. If provided, CPOA will attempt to send real-time progress updates via ASF to this client.
    -   **Success Response (201 Created - if CPOA completes successfully with audio):**
        ```json
        {
            "podcast_id": "uuid-generated-by-api-gw",
            "topic": "The History of Podcasting",
            "generation_status": "completed", // Status from CPOA
            "audio_url": "/api/v1/podcasts/uuid-generated-by-api-gw/audio.mp3",
            "message": "Podcast generation task processed. Final status: completed.",
            "details": { /* Full cpoa_result from CPOA, including final_audio_details.tts_settings_used */ }
        }
        ```
    -   **Success Response (200 OK - if CPOA processes but with warnings/errors, or fails internally):**
        The HTTP status is 200 because the API Gateway successfully handled the request and CPOA processed it, even if the outcome from CPOA wasn't a clean success. The payload indicates the actual status.
        ```json
        {
            "podcast_id": "uuid-generated-by-api-gw",
            "topic": "The History of Podcasting",
            "generation_status": "failed_vfa_tts", // Example failure status from CPOA
            "message": "VFA service call failed after retries...", // Error message from CPOA
            "details": { /* Full cpoa_result from CPOA */ }
        }
        ```
    -   **Error Responses:**
        -   `400 Bad Request`: If `topic` is missing or empty, or if `voice_params` is not a valid object.
        -   `503 Service Unavailable`: If the CPOA's `orchestrate_podcast_generation` function cannot be imported/found.
        -   `500 Internal Server Error`: For database errors during initial record creation or other unexpected issues within the API Gateway.

-   **`GET /api/v1/podcasts`**
    -   **Description:** Lists all podcast generation tasks with pagination.
    -   **Query Parameters:**
        -   `page` (optional, integer): Page number to retrieve. Defaults to 1.
        -   `per_page` (optional, integer): Number of items per page. Defaults to 10 (max 100).
    -   **Success Response (200 OK):**
        ```json
        {
            "podcasts": [
                {
                    "podcast_id": "uuid-xyz",
                    "topic": "Another Interesting Topic",
                    "task_created_timestamp": "2024-03-15T10:00:00Z",
                    "status": "completed", // cpoa_status from DB
                    "audio_url": "/api/v1/podcasts/uuid-xyz/audio.mp3" // or null if no audio
                }
                // ... other podcasts
            ],
            "page": 1,
            "per_page": 10,
            "total_podcasts": 25,
            "total_pages": 3
        }
        ```
    -   **Error Responses:**
        -   `400 Bad Request`: For invalid `page` or `per_page` parameters.
        -   `500 Internal Server Error`: For database errors.

-   **`GET /api/v1/podcasts/<podcast_id>`**
    -   **Description:** Retrieves detailed information for a specific podcast task.
    -   **Path Parameters:**
        -   `podcast_id` (string): The unique ID of the podcast.
    -   **Success Response (200 OK):**
        ```json
        {
            "podcast_id": "uuid-xyz",
            "topic": "Another Interesting Topic",
            "status": "completed", // cpoa_status from DB
            "error_message": null, // cpoa_error_message from DB
            "audio_url": "/api/v1/podcasts/uuid-xyz/audio.mp3",
            "final_audio_filepath": "/srv/aethercast/audio/file.mp3",
            "stream_id": "stream_id_from_vfa",
            "asf_websocket_url": "ws://asf_host/path/stream_id_from_vfa",
            "asf_notification_status": "ASF notified successfully.",
            "task_created_timestamp": "2024-03-15T10:00:00Z",
            "last_updated_timestamp": "2024-03-15T10:05:00Z",
            "orchestration_log": [ /* Parsed JSON from cpoa_full_orchestration_log */ ],
            "tts_settings_used": { // Parsed JSON from tts_settings_used DB column
                "voice_name": "en-GB-News-K",
                "language_code": "en-GB",
                "speaking_rate": 0.9,
                "pitch": -1.5,
                "audio_encoding": "MP3"
            }
        }
        ```
    -   **Error Responses:**
        -   `404 Not Found`: If the `podcast_id` does not exist.
        -   `500 Internal Server Error`: For database errors.

-   **`GET /api/v1/podcasts/<podcast_id>/audio.mp3`**
    -   **Description:** Serves the generated audio file for the specified podcast.
    -   **Path Parameters:**
        -   `podcast_id` (string): The unique ID of the podcast.
    -   **Success Response (200 OK):**
        -   The raw audio data (e.g., `audio/mpeg` content type).
    -   **Error Responses:**
        -   `404 Not Found`: If the podcast record doesn't exist, `final_audio_filepath` is null, or the audio file itself is missing from the filesystem.
        -   `500 Internal Server Error`: For database errors when retrieving the filepath.

### Search Podcasts

-   **`POST /api/v1/search/podcasts`**
    -   **Description:** Searches for podcast topics based on a query string and returns a list of AI-generated summaries or snippets for the matching topics.
    -   **Request Payload (JSON):**
        ```json
        {
            "query": "artificial intelligence in healthcare"
        }
        ```
        -   `query` (string, required): The search query string.
    -   **Success Response (200 OK):**
        ```json
        {
            "search_results": [
                {
                    "snippet_id": "search_res_snippet_uuid_1",
                    "topic_id": "topic_uuid_abc",
                    "title": "AI Revolutionizing Healthcare Diagnostics",
                    "summary": "An AI-generated summary about how artificial intelligence is making strides in diagnosing medical conditions with greater accuracy and speed.",
                    "cover_art_prompt": "Abstract image of AI and medical symbols intertwined",
                    "image_url": "https://example.com/images/search_res_snippet_uuid_1.jpg",
                    "keywords": ["AI", "healthcare", "diagnostics"]
                }
                // ... more search results
            ]
        }
        ```
    -   **Error Responses:**
        -   `400 Bad Request`: If `query` is missing, empty, or invalid.
        -   `500 Internal Server Error`: For unexpected errors during search processing (e.g., CPOA failure).
        -   `503 Service Unavailable`: If a critical downstream service (like TDA or SCA via CPOA) is unavailable.

### Session Management

-   **`POST /api/v1/session/init`**
    -   **Description:** Initializes or acknowledges a user session. If the `client_id` is new, a session record is created with default/empty preferences. If the `client_id` already exists, its `last_seen_timestamp` is updated.
    -   **Request Payload (JSON):**
        ```json
        {
            "client_id": "your_unique_frontend_generated_client_id"
        }
        ```
        -   `client_id` (string, required): A unique identifier generated by the frontend for the user's session.
    -   **Success Response (200 OK):**
        ```json
        {
            "client_id": "your_unique_frontend_generated_client_id",
            "preferences": {
                // User's current preferences, or {} if new session/no preferences set
                "news_category": "technology"
            }
        }
        ```
    -   **Error Responses:**
        -   `400 Bad Request`: If `client_id` is missing.
        -   `500 Internal Server Error`: For database errors.

-   **`GET /api/v1/session/preferences`**
    -   **Description:** Retrieves the current preferences for a given user session.
    -   **Query Parameters:**
        -   `client_id` (string, required): The unique identifier for the user's session.
    -   **Success Response (200 OK):**
        ```json
        {
            "client_id": "your_unique_frontend_generated_client_id",
            "preferences": {
                "news_category": "technology",
                "preferred_voice_name": "en-US-Wavenet-D"
                // ... other preferences
            }
        }
        ```
        (Returns `{"preferences": {}}` if no preferences are set).
    -   **Error Responses:**
        -   `400 Bad Request`: If `client_id` query parameter is missing.
        -   `404 Not Found`: If the session for the given `client_id` does not exist (client should call `/api/v1/session/init` first).
        -   `500 Internal Server Error`: For database errors or issues parsing stored preferences.

-   **`POST /api/v1/session/preferences`**
    -   **Description:** Updates the preferences for a given user session.
    -   **Request Payload (JSON):**
        ```json
        {
            "client_id": "your_unique_frontend_generated_client_id",
            "preferences": {
                "news_category": "science",
                "items_per_page": 20
                // Any other key-value pairs for preferences
            }
        }
        ```
        -   `client_id` (string, required): The user's session identifier.
        -   `preferences` (object, required): A dictionary containing the preferences to save. This will overwrite any existing preferences for the session.
    -   **Success Response (200 OK):**
        ```json
        {
            "client_id": "your_unique_frontend_generated_client_id",
            "message": "Preferences updated successfully."
        }
        ```
    -   **Error Responses:**
        -   `400 Bad Request`: If `client_id` or `preferences` are missing, or if `preferences` is not a dictionary.
        -   `404 Not Found`: If the session for the given `client_id` does not exist.
        -   `500 Internal Server Error`: For database errors.


## Database Schema Details

The API Gateway, along with CPOA and TDA, utilizes a shared SQLite database. Key tables include:

### `podcasts` Table
-   **Purpose:** Tracks the status and metadata of each podcast generation task.
-   **Key Columns:**
    -   `podcast_id` (TEXT PRIMARY KEY): Unique ID for the podcast task.
    -   `topic` (TEXT): The user-provided topic for the podcast.
    -   `cpoa_status` (TEXT): Current status from CPOA (e.g., "pending_api_gateway", "completed", "failed_pswa_error").
    -   `cpoa_error_message` (TEXT): Detailed error message if the task failed.
    -   `final_audio_filepath` (TEXT): Absolute path to the final generated audio file.
    -   `stream_id` (TEXT): Stream ID provided by VFA, used by ASF.
    -   `asf_websocket_url` (TEXT): Full WebSocket URL for clients to connect to ASF for this stream.
    -   `asf_notification_status` (TEXT): Status of the notification sent to ASF.
    -   `task_created_timestamp` (TEXT): ISO 8601 timestamp when the task was created.
    -   `last_updated_timestamp` (TEXT): ISO 8601 timestamp when the record was last updated.
    -   `cpoa_full_orchestration_log` (TEXT): JSON string containing a detailed log of CPOA's orchestration steps.
    -   `tts_settings_used` (TEXT): JSON string detailing the actual Text-to-Speech parameters used by VFA for synthesis (e.g., voice name, language, rate, pitch).

### `topics_snippets` Table
-   **Purpose:** Stores discovered topics from TDA and generated snippets from CPOA (via SCA). Used by the API Gateway as a cache for the `/api/v1/snippets` endpoint.
-   **Key Columns:**
    -   `id` (TEXT PRIMARY KEY): Unique ID (e.g., `topic_id` from TDA or `snippet_id` from SCA).
    -   `type` (TEXT): Indicates if the entry is a 'topic' or a 'snippet'.
    -   `title` (TEXT): Title of the topic or snippet.
    -   `summary` (TEXT): Summary or main content.
    -   `keywords` (TEXT): JSON string array of keywords (e.g., `["ai", "tech"]`).
    -   `source_url` (TEXT): For topics, the primary article URL. For snippets, can be null or related topic URL.
    -   `source_name` (TEXT): For topics, the news source name.
    -   `original_topic_details` (TEXT): For snippets, a JSON string of the original `TopicObject` from TDA that prompted its generation. Null for topics.
    -   `llm_model_used_for_snippet` (TEXT): For snippets, the LLM model used by SCA.
    -   `cover_art_prompt` (TEXT): For snippets, the prompt used for generating cover art.
    -   `generation_timestamp` (TEXT): ISO 8601 timestamp when the item was created/generated.
    -   `last_accessed_timestamp` (TEXT): ISO 8601 timestamp when the item was last fetched/used by the API Gateway (for cache management).
    -   `relevance_score` (REAL): Relevance score, e.g., for topics from TDA.

### `user_sessions` Table
-   **Purpose:** Stores user session information and preferences.
-   **Key Columns:**
    -   `session_id` (TEXT PRIMARY KEY): Unique identifier for the session, corresponds to `client_id` generated by the frontend.
    -   `created_timestamp` (TEXT): ISO 8601 timestamp when the session was first created.
    -   `last_seen_timestamp` (TEXT): ISO 8601 timestamp when the session was last active (e.g., made a request).
    -   `preferences_json` (TEXT): A JSON string storing user preferences as a dictionary (e.g., `{"news_category": "technology", "preferred_voice": "en-US-Standard-A"}`).
