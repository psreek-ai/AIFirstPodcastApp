# Endpoint: POST /api/v1/podcasts

## Description
This endpoint initiates a podcast generation task. The API Gateway creates a preliminary record for the task and then calls the Central Podcast Orchestrator Agent (CPOA) to manage the multi-step generation process (content harvesting, script weaving, voice synthesis). The API Gateway returns a response indicating the task's acceptance and initial status, along with details from CPOA's processing.

## Request Body
- Type: `application/json`
- **Schema:**
  ```json
  {
    "topic": "string", // Required: The main topic for the podcast.
    "voice_params": { // Optional: Parameters for voice synthesis.
      "voice_name": "string", // e.g., "en-US-Wavenet-D"
      "language_code": "string", // e.g., "en-US"
      "speaking_rate": "number", // e.g., 1.1 (0.25 to 4.0)
      "pitch": "number" // e.g., -2.5 (-20.0 to 20.0)
    },
    "client_id": "string", // Optional: A unique identifier for the client session, used for real-time UI updates via ASF.
    "test_scenarios": { // Optional: For integration testing. Allows specifying test behavior for downstream services.
      "pswa": "string", // e.g., "insufficient_content", "error_during_llm_call"
      "vfa": "string" // e.g., "error_tts_timeout", "skip_synthesis"
      // Other services like SCA, TDA, IGA can also be targeted if CPOA supports passing test scenarios to them.
    }
  }
  ```
- **Example:**
  ```json
  {
    "topic": "The Impact of Quantum Computing on Cybersecurity",
    "voice_params": {
      "voice_name": "en-GB-News-K",
      "speaking_rate": 0.95
    },
    "client_id": "session_user_abc123",
    "test_scenarios": {
      "vfa": "error_tts_timeout"
    }
  }
  ```

## Success Responses

-   **201 Created:** Typically returned when CPOA successfully initiates and completes the generation process, resulting in an audio file. The response body contains full details.
-   **200 OK:** Returned if the API Gateway successfully handles the request and CPOA processes it, but the outcome from CPOA might include warnings or internal errors (e.g., VFA skipped, ASF notification failed, or a downstream service reported an error but CPOA handled it gracefully). The response body will indicate the actual status.

- **Response Body Schema (JSON):**
  ```json
  {
    "podcast_id": "string", // UUID generated by API Gateway for this task
    "topic": "string", // The topic of the podcast
    "generation_status": "string", // Overall status from CPOA (e.g., "completed", "failed_vfa_error", "completed_with_asf_notification_failure")
    "message": "string", // Summary message about the outcome (can be an error message if generation_status indicates failure)
    "audio_url": "string", // Optional: Relative URL to the audio file, e.g., "/api/v1/podcasts/{podcast_id}/audio.mp3". Present if audio is successfully generated.
    "details": { // Comprehensive result object from CPOA
      "task_id": "string", // Matches podcast_id, CPOA's identifier for the task
      "status": "string", // CPOA's internal final status for the orchestration
      "error_message": "string", // Optional: Detailed error message from CPOA if an issue occurred
      "asf_notification_status": "string", // Optional: Status of the notification sent to ASF
      "asf_websocket_url": "string", // Optional: Base WebSocket URL for ASF clients to connect for this stream
      "final_audio_details": { // Details from VFA (via AIMS_TTS service if applicable)
        "status": "string", // "success", "skipped", or "error" (VFA's perspective)
        "message": "string", // Message from VFA
        "audio_filepath": "string", // Absolute path to the audio file on the shared volume (server-side)
        "stream_id": "string", // Unique ID for this audio stream, used by ASF
        "audio_format": "string", // e.g., "mp3", "ogg_opus"
        "script_char_count": "integer", // Number of characters in the script processed by VFA/TTS
        "engine_used": "string", // Identifier of the TTS engine used (e.g., "google_tts")
        "tts_settings_used": { // Actual TTS parameters that were used for synthesis
          "voice_name": "string",
          "language_code": "string",
          "speaking_rate": "number",
          "pitch": "number",
          "audio_encoding": "string" // e.g., "MP3"
        }
      },
      "orchestration_log": [ // Array of log entries from CPOA's process
        {
          "timestamp": "string", // ISO 8601 format
          "stage": "string", // e.g., "wcha_content_retrieval", "pswa_script_generation"
          "message": "string", // Description of the step or outcome
          "data_preview": "string" // Optional: Preview of data associated with the step
          // "structured_data" might also be present in some log entries
        }
      ]
    }
  }
  ```

- **Example (201 Created - Successful Generation):**
  ```json
  {
    "podcast_id": "task_uuid_12345",
    "topic": "The Impact of Quantum Computing on Cybersecurity",
    "generation_status": "completed",
    "message": "Podcast generation task processed. Final status: completed.",
    "audio_url": "/api/v1/podcasts/task_uuid_12345/audio.mp3",
    "details": {
      "task_id": "task_uuid_12345",
      "status": "completed",
      "error_message": null,
      "asf_notification_status": "ASF notified successfully for stream strm_abc...",
      "asf_websocket_url": "ws://localhost:5006/api/v1/podcasts/stream",
      "final_audio_details": {
        "status": "success",
        "message": "Audio synthesized and saved successfully.",
        "audio_filepath": "/shared_audio/aims_tts/task_uuid_12345_random.mp3",
        "stream_id": "strm_abc123xyz",
        "audio_format": "mp3",
        "script_char_count": 3500,
        "engine_used": "google_tts",
        "tts_settings_used": {
          "voice_name": "en-GB-News-K",
          "language_code": "en-GB",
          "speaking_rate": 0.95,
          "pitch": 0.0,
          "audio_encoding": "MP3"
        }
      },
      "orchestration_log": [
        {
          "timestamp": "2024-03-15T10:00:00Z",
          "stage": "initialization",
          "message": "Orchestration process started."
        }
        // ... other log entries ...
      ]
    }
  }
  ```

- **Example (200 OK - Generation Failed within CPOA, e.g., VFA error):**
  ```json
  {
    "podcast_id": "task_uuid_67890",
    "topic": "Exploring Ancient Civilizations",
    "generation_status": "failed_vfa_error", // Example failure status from CPOA
    "message": "VFA service call failed after retries: Connection timeout.", // Error message from CPOA
    "audio_url": null,
    "details": {
      "task_id": "task_uuid_67890",
      "status": "failed_vfa_request_exception", // CPOA's internal status
      "error_message": "VFA service call failed after retries: Connection timeout.",
      "asf_notification_status": null,
      "asf_websocket_url": null,
      "final_audio_details": {
        "status": "error", // VFA's perspective
        "message": "VFA service call failed after retries: Connection timeout.",
        "audio_filepath": null,
        "stream_id": null,
        "tts_settings_used": { /* voice_params requested */ }
      },
      "orchestration_log": [ /* ... relevant logs ... */ ]
    }
  }
  ```

## Error Responses (API Gateway Level)

-   **400 Bad Request:** If the request payload is invalid (e.g., `topic` is missing or not a string, `voice_params` is not an object).
    ```json
    {
        "error_code": "API_GW_PODCAST_TOPIC_REQUIRED",
        "message": "A topic is required to generate a podcast.",
        "details": "Missing or empty 'topic' in request body."
    }
    ```
-   **503 Service Unavailable:** If the CPOA's `orchestrate_podcast_generation` function cannot be imported/found by the API Gateway.
    ```json
    {
        "error_code": "API_GW_CPOA_PODCAST_SERVICE_UNAVAILABLE",
        "message": "Core podcast orchestration module is currently unavailable.",
        "details": "Import error details..."
    }
    ```
-   **500 Internal Server Error:** For database errors during initial task record creation or other unexpected issues within the API Gateway before CPOA is called.
    ```json
    {
        "error_code": "API_GW_PODCAST_DB_ERROR_CREATE_TASK",
        "message": "Failed to create initial podcast task record due to a database issue.",
        "details": "Specific database error."
    }
    ```
